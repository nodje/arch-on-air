---
- name: arch-on-air post-installation playbook
  hosts: host
  vars:
    travis_ci: false
    sucklessdir: "~/suckless"
  gather_facts: true
  tasks:
    - debug: msg="Hurrah! we have wlan0 in ansible interfaces!" verbosity=1
      when: '"wlan0" in ansible_interfaces'
    # - name: Install Python using a raw SSH command to enable the execution of Ansible modules
    #   raw: pacman -S python --noconfirm
    #   args:
    #     executable: /bin/bash
    #   changed_when: false
    #   become: true

    - name: first upgrade the system
      pacman:
        update_cache: yes
        upgrade: yes
      become: true
      register: packages
    - debug: var=packages

    - name: copy files under /etc
      copy:
        src: "files/etc/{{ item }}"
        dest: "/etc/{{ item }}"
        mode: 0644
        owner: root
        group: root
      with_items:
        - vconsole.conf
        - systemd/
        #- modprobe.d/
        - wpa_supplicant/wpa_supplicant.conf
        - X11/xorg.conf.d/
      become: true
    - name: change console font when HiDPI
      lineinfile:
        line: "FONT=ter-132n"
        path: /etc/vconsole.conf
      when: ishidpi
      become: true

    - name: install HiDPI related fonts
      pacman: name={{ item }} state=latest
      with_items:
        - terminus-font
        - adobe-source-code-pro-fonts
      when: ishidpi
      become: true

    - name: install wm stuff
      pacman: name={{ item }} state=latest
      with_items:
        #- lightdm
        #- lighdm-gtk-greeter
        - avahi
        - qt4 #for vlc
        - vlc
        - syncthing
        - xclip #utility to cli copy to clipboard
      become: true

      #- name: modify lightdm conf
      #
        #greeter-session=lightdm-gtk-greeter
        #systemctl enable lightdm.service
    - name: start enable systemd-networkd
      service:
        name: systemd-networkd
        state: started
        enabled: true

    - name: install networkmanager, bonjour and macos network .local name recognition
      pacman: name={{ item }} state=latest
      with_items:
        - avahi
        - nss-mdns
        - networkmanager
        - ifplugd #to be able to detect and automount wired connections
        #- wpa_actiond #to auto mount wireless connections with netctl
        - wpa_supplicant
      become: true

    - name: configure /etc/nssswitch.conf
      lineinfile:
        path: /etc/nsswitch.conf
        regexp: '^hosts: '
        line: 'hosts: files mymachines mdns_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] dns myhostname'
      become: true
    - name: ensure avahi-daemon.service is enabled and started
      systemd:
        name: avahi-daemon.service
        state: started
        enabled: true
      become: true

    - name: ensure /etc/avahi/services is created to avoid boot msg error
      file:
        path: /etc/avahi/services
        state: directory
        mode: 0755
      become: true

    - name: Revert to traditional network device names
      file:
        src: /dev/null
        path: /etc/udev/rules.d/80-net-setup-link.rules
        state: link

    - name: start && enable service dhcpcd@wlan0
      service:
        name: dhcpcd@wlan0
        state: started
        enabled: true
      when: '"wlan0" in ansible_interfaces'

    # - name: ensure netctl-ifplugd@eth0.service is enabled and started
    #   systemd:
    #     name: netctl-ifplugd@eth0.service
    #     state: started
    #     enabled: true
    #   become: true
    #   ignore_errors: true

    # - name: ensure netctl-auto@wlan0.service is enabled and started
    #   systemd:
    #     name: netctl-auto@wlan0.service
    #     state: started
    #     enabled: true
    #   become: true
    #   ignore_errors: true

    - name: install samba and configure
      pacman: name={{ item }} state=latest
      with_items:
        - samba
      become: true
     #- name: install and configure Suckless st, dmenu, dwm
    #- name: modify st font and font size
    #-name: modify virtual console font and font size
    # -name: download browser plugin and place them in the right config folder.
    # -name: configure ajust screen brightness buttons

    - name: install python2/3 as a start
      pacman: name={{ item }} state=latest
      with_items:
        - python
        - python-pip
        - python2
        - python2-pip
        - python2-six
      become: true

    - name: install console apps
      pacman: name={{ item }} state=latest
      with_items:
        - vim
        - emacs
        - tmux
        - tree
        - jq
        - acpi
        - dialog
        - aspell
        - aspell-en
        - busybox
        - dosfstools
        - cowsay
        - pulseaudio
        - alsa-utils
      become: true

    - name: install network tools
      pacman: name={{ item }} state=latest
      with_items:
        - w3m
        - elinks
        - curl
        - nmap
        - tcpdump
        - traceroute
        - net-tools
        - bind-tools
        - gnu-netcat
        - mtr
        - rsync
        - irssi
        - mutt
        - cyrus-sasl
        - ebtables
        - dnsmasq
        - openconnect
      become: true

    #- name: configure mutt for gmail account
    #  template:

    - name: install graphical libraries & tools
      pacman: name={{ item }} state=latest
      with_items:
        - gcr
        # lib needed to compile dwm
        - libxft
        - libxinerama
        - pkg-config
        # end
        - xf86-video-intel
        - xf86-input-libinput
        - xf86-input-synaptics
        - xorg-server
        - xorg-xinit
        - xorg-xset
        - xorg-xsetroot
        - xorg-xinput
        - xorg-xprop
        - ttf-freefont
        - gtk3
        - webkit2gtk
        - mupdf
        - chromium
        - firefox
        - wireshark-gtk
      become: true

    - name: create dir for suckles tools git cloning
      file:
        state: directory
        path: "{{ sucklessdir }}"
    - name: checkout & make suckless dwm
      git:
        repo: 'http://git.suckless.org/dwm'
        dest: "{{ sucklessdir }}/dwm"

    - name: checkout & make suckless st
      git:
        repo: 'http://git.suckless.org/st'
        dest: "{{ sucklessdir }}/st"
    # - name: download and apply patches

    - name: checkout & make suckless dmenu
      git:
        repo: 'http://git.suckless.org/dmenu'
        dest: "{{ sucklessdir }}/dmenu"

    - name: checkout & make suckless surf
      git:
        repo: 'http://git.suckless.org/surf'
        dest: "{{ sucklessdir }}/surf"

    - name: configure st/config.h
      lineinfile:
        path: "{{ sucklessdir }}/st/config.h"
        regexp: '^char font'
        line: 'char font[] = "Source Code Pro:style=Semibold:size=8";'

    - name: make st
      make:
        chdir: "{{ sucklessdir }}/st"
      register: result
    - name: make install st
      make:
        chdir: "{{ result.chdir }}"
        target: install
      become: true

    - name: make dwm
      make:
        chdir: "{{ sucklessdir }}/dwm"
      register: result
    - name: make install dwm
      make:
        chdir: "{{ result.chdir }}"
        target: install
      become: true

    - name: make dmenu
      make:
        chdir: "{{ sucklessdir }}/dmenu"
      register: result
    - name: make install dmenu
      make:
        chdir: "{{ result.chdir }}"
        target: install
      become: true

    - name: make surf
      make:
        chdir: "{{ sucklessdir }}/surf"
      register: result
    - name: make install surf
      make:
        chdir: "{{ result.chdir }}"
        target: install
      become: true
    #- name: configure the audio
    #  import_tasks: tasks/audio.yml
